import streamlit as st
import pandas as pd
from PIL import Image
import math
from io import BytesIO

# GitHub'dan Excel dosyasÄ±nÄ± oku
excel_url = "https://raw.githubusercontent.com/akayacan/kayacanlar-cit-appj/main/urun_listesi.xlsx"
df_urun = pd.read_excel(excel_url)
df_urun["ÃœrÃ¼n AdÄ±"] = df_urun["ÃœrÃ¼n AdÄ±"].str.strip().replace("UYARI TABELESA", "UYARI TABELASI")

fiyatlar = dict(zip(df_urun["ÃœrÃ¼n AdÄ±"], df_urun["Fiyat (TL)"].fillna(0)))
kodlar = dict(zip(df_urun["ÃœrÃ¼n AdÄ±"], df_urun["Kod"].fillna("")))

st.set_page_config(layout="wide")
st.title("KAYACANLAR - Ã‡it Malzeme Hesaplama ProgramÄ±")

en = st.number_input("Tarla En (m)", min_value=0, step=1)
boy = st.number_input("Tarla Boy (m)", min_value=0, step=1)
hayvan = st.selectbox("Hayvan TÃ¼rÃ¼", ["AyÄ±", "Domuz", "Tilki", "At", "KÃ¼Ã§Ã¼kbaÅŸ", "BÃ¼yÃ¼kbaÅŸ"])
arazi = st.selectbox("Arazi Tipi", ["DÃ¼z", "Otluk", "EÄŸimli"])
tel_tipi = st.selectbox("Tel Tipi", ["MISINALI", "GALVANIZ", "ÅžERIT"])

tel_model_options = {
    "MISINALI": ["MISINALI TEL 2mm", "MISINALI TEL 3mm", "MISINALI TEL 4mm"],
    "GALVANIZ": ["GALVANIZ TEL 1mm", "GALVANIZ TEL 1.25mm"],
    "ÅžERIT": ["ÅžERIT TEL"]
}

tel_model = st.selectbox("Tel Modeli", tel_model_options.get(tel_tipi, []))

direk_tipi = st.selectbox("Direk Tipi", ["AhÅŸap", "Ä°nÅŸaat Demiri", "KÃ¶ÅŸebent", "Ã–rgÃ¼ Tel", "Plastik"])

plastik_model = ""
if direk_tipi == "Plastik":
    plastik_model = st.selectbox("Plastik Direk Modeli", [
        "PLASTIK DIREK 100cm SIYAH",
        "PLASTIK DIREK 100cm BEYAZ",
        "PLASTIK DIREK 105cm SIYAH",
        "PLASTIK DIREK 105cm BEYAZ",
        "PLASTIK DIREK 125cm SIYAH",
        "PLASTIK DIREK 125cm BEYAZ"
    ])

tel_makara_uzunlugu = {
    "ÅžERIT TEL": 200
}
tel_makara_uzunlugu_default = 500

# Ä°zalatÃ¶r aparat seÃ§imi
aparatlar_dict = {
    "AhÅŸap": [
        "HALKA IZALATOR VIDALI SIYAH", "HALKA IZALATOR VIDALI RENKLI",
        "HALKA IZALATOR SOMUNLU RENKLI", "HALKA IZALATOR SOMUNLU UZUN"
    ],
    "Ä°nÅŸaat Demiri": ["MIL IZALATORU R=10-18", "MIL IZALATORU R=8-14"],
    "KÃ¶ÅŸebent": ["HALKA IZALATOR SOMUNLU RENKLI", "HALKA IZALATOR SOMUNLU UZUN", "KOSE IZALATOR"],
    "Ã–rgÃ¼ Tel": ["AÄž IZALATORU"]
}

st.subheader("ðŸ”© Ä°zolatÃ¶rler")
secilen_aparatlar = []
toplam_tel = 2 * (en + boy) * {"AyÄ±": 4, "Domuz": 3, "Tilki": 4, "At": 4, "KÃ¼Ã§Ã¼kbaÅŸ": 4, "BÃ¼yÃ¼kbaÅŸ": 2}.get(hayvan, 0)
izolator_sayisi_otomatik = math.ceil(toplam_tel / 5)

for aparat in aparatlar_dict.get(direk_tipi, []):
    col1, col2 = st.columns([3, 1])
    with col1:
        secim = st.radio(aparat, ["HayÄ±r", "Evet"], horizontal=True, key=aparat)
    with col2:
        adet = st.number_input(f"{aparat} Adet", min_value=0, value=izolator_sayisi_otomatik if secim == "Evet" else 0, step=1, key=aparat+"_adet")
    if secim == "Evet" and adet > 0:
        secilen_aparatlar.append({
            "Malzeme": aparat,
            "Adet": adet,
            "Birim Fiyat": fiyatlar.get(aparat.strip(), 0),
            "Kod": kodlar.get(aparat.strip(), "")
        })

# YardÄ±mcÄ± ekipmanlar
st.subheader("ðŸ§° YardÄ±mcÄ± Ekipmanlar")
ekipmanlar = [
    "KAPI", "TOPRAKLAMA Ã‡UBUÄžU", "UYARI TABELASI", "ENERJI AKTARMA KABLOSU",
    "AKÃœ ÅžARJ ALETI", "YILDIRIM SAVAR", "TEL GERDIRICI"
]
secilen_ekipmanlar = []
for ekipman in ekipmanlar:
    col1, col2 = st.columns([3, 1])
    with col1:
        secim = st.radio(ekipman, ["HayÄ±r", "Evet"], horizontal=True, key=ekipman)
    with col2:
        adet = st.number_input(f"{ekipman} Adet", min_value=0, step=1, key=ekipman+"_adet")
    if secim == "Evet" and adet > 0:
        secilen_ekipmanlar.append({
            "Malzeme": ekipman,
            "Adet": adet,
            "Birim Fiyat": fiyatlar.get(ekipman.strip(), 0),
            "Kod": kodlar.get(ekipman.strip(), "")
        })
 if st.button("HESAPLA"):
    cevre = 2 * (en + boy)
    tel_sira = {"AyÄ±": 4, "Domuz": 3, "Tilki": 4, "KÃ¼Ã§Ã¼kbaÅŸ": 4, "BÃ¼yÃ¼kbaÅŸ": 2}[hayvan]
    direk_aralik = {"DÃ¼z": 4, "Otluk": 3, "EÄŸimli": 2}[arazi]
    toplam_tel = cevre * tel_sira

    # diÄŸer hesaplamalar...

    df = pd.DataFrame(liste)
    df.index = range(1, len(df) + 1)
    df["Toplam"] = df["Adet"] * df["Birim Fiyat"]
    toplam = df["Toplam"].sum()

    st.subheader("ðŸ“¦ Malzeme ve Fiyat Listesi")
    st.dataframe(df, use_container_width=True)
    st.markdown(f"### ðŸ’° Toplam Maliyet: **{toplam:.2f} TL**")

    # Excel Ã§Ä±ktÄ±sÄ±
    excel_data = BytesIO()
    df.to_excel(excel_data, index=False)
    st.download_button(
        label="ðŸ“¥ Excel Ã‡Ä±ktÄ±sÄ±nÄ± Ä°ndir",
        data=excel_data.getvalue(),
        file_name="cit_malzeme_listesi.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )
       
